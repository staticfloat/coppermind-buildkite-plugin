#!/bin/bash

COPPERMIND_REPO="$( cd "$( dirname "$( dirname "${BASH_SOURCE[0]}" )" )" &> /dev/null && pwd )"
source "${COPPERMIND_REPO}/lib/common.sh"

# Skip uploading if the pre-command says we've already done this
if [[ -f .buildkite_plugin_coppermind_skip_command ]]; then
    rm -f .buildkite_plugin_coppermind_skip_command
    echo "Skipping upload, as we had a cache hit"
    exit 0
fi

# Upload each of our patterns, using buildkite-agent artifact to do so
OUTPUT_PATTERNS=()
PATTERN_IDX=0
while [[ -v "BUILDKITE_PLUGIN_COPPERMIND_OUTPUTS_${PATTERN_IDX}" ]]; do
    # Fetch the pattern
    PATTERN_VARNAME="BUILDKITE_PLUGIN_COPPERMIND_OUTPUTS_${PATTERN_IDX}"
    OUTPUT_PATTERNS+=( "${!PATTERN_VARNAME}" )

    PATTERN_IDX=$((${PATTERN_IDX} + 1))
done

echo "output_patterns: ${OUTPUT_PATTERNS[@]}"

buildkite-agent artifact upload "$(join_by ";" ${OUTPUT_PATTERNS[@]})" "${S3_PREFIX}/${BUILDKITE_PLUGIN_COPPERMIND_INPUT_HASH}"
